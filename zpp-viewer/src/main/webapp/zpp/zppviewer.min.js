(function(c){c.ZppViewer=function(){};c.widget("zpp.ZppViewer",{options:{debug:!1,autoRatio:!0,thumbnail:!1,showToolbar:!0,toolbarPos:"bottom right",toolbarIconSize:32},_create:function(){this.canvas=this.element[0];if("canvas"!==this.canvas.nodeName.toLowerCase())throw alert("The ZppViewer must use a canvas, not a "+this.canvas.nodeName),"The ZppViewer must use a canvas, not a "+this.canvas.nodeName;this.context=this.canvas.getContext("2d");c(this.canvas).addClass("zppviewer");this.emptyImageUrl=
c(this.canvas).css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.trace=this.hasFocus=!1;this.debug=this.options.debug||this.element.attr("zpp-debug");this.showToolbar=this.options.showToolbar||this.element.attr("zpp-showToolbar");this.toolbarPos=this.options.toolbarPos||this.element.attr("zpp-toolbarPos")||"bottom";this.toolbarIconSize=this.options.toolbarIconSize||this.element.attr("zpp-toolbarIconSize")||"32";this.thumbnail=this.options.thumbnail||this.element.attr("zpp-thumbnail");
this.src=this.options.src||this.element.attr("zpp-src")||null;this.imageWidth=this.options.imageWidth||this._attrIntValue("zpp-imageWidth");this.imageHeight=this.options.imageHeight||this._attrIntValue("zpp-imageHeight");this.tileSize=this.options.tileSize||this._attrIntValue("zpp-tileSize")||null;this.background=this.options.background||this.element.attr("zpp-background");this.cssWidth=this.cssWidth0=parseInt(c(this.canvas).css("width"));this.cssHeight=this.cssHeight0=parseInt(c(this.canvas).css("height"));
this.options.autoRatio||this.element.attr("zpp-autoRatio")?this._autoAdjustCanvasToPixelRatio():this.deviceRatio=1;this.width=parseInt(c(this.canvas).attr("width"));this.height=parseInt(c(this.canvas).attr("height"));this.scale=1;this.offset={x:0,y:0,x0:0,y0:0};this._bindEvents();this.thumbnail&&this._loadThumbnail();this.showToolbar&&"none"!=this.showToolbar&&this._createToolbar();!this.tileSize||!this.imageWidth||!this.imageHeight?this._loadImageProperties():(this._log("Image dimensions specified: width=%d, height=%d, tile-size=%d",
this.imageWidth,this.imageHeight,this.tileSize),this._calculateZoomLevels())},_attrIntValue:function(a){a=this.element.attr(a);return"undefined"!==typeof a&&a?parseInt(a):null},_autoAdjustCanvasToPixelRatio:function(){this.devicePixelRatio=window.devicePixelRatio||1;this.backingStoreRatio=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1;this.deviceRatio=
this.devicePixelRatio/this.backingStoreRatio;this.devicePixelRatio!==this.backingStoreRatio&&(this._log("Adjusting to pixel ratio %f",this.deviceRatio),this.cssWidth=parseInt(c(this.canvas).attr("width")),this.cssHeight=parseInt(c(this.canvas).attr("height")),c(this.canvas).attr("width",Math.round(this.cssWidth*this.deviceRatio)),c(this.canvas).attr("height",Math.round(this.cssHeight*this.deviceRatio)),c(this.canvas).css("width",this.cssWidth),c(this.canvas).css("height",this.cssHeight),this.context.scale(this.deviceRatio,
this.deviceRatio))},_createToolbar:function(){this.toolbar={x:0,y:0,w:0,h:0};this._createToolbarBtn("homeBtn","btn_home.png",0,c.proxy(this._reset,this));this._createToolbarBtn("zoomInBtn","btn_zoomIn.png",1,c.proxy(this._zoomIn,this,1.2));this._createToolbarBtn("zoomOutBtn","btn_zoomOut.png",2,c.proxy(this._zoomOut,this,1.2));this._supportsFullscreen()&&(this._createToolbarBtn("startFullscreenBtn","btn_startFullscreen.png",3,c.proxy(this._toggleFullscreen,this)),this._createToolbarBtn("stopFullscreenBtn",
"btn_stopFullscreen.png",3,c.proxy(this._toggleFullscreen,this)));this._positionToolbar()},_createToolbarBtn:function(a,b,d,g){this.toolbar[a]={name:a,index:d,action:g,image:null,x:0,y:0};d=new Image;d.onload=c.proxy(this._toolbarBtnLoaded,this,d,this.toolbar[a]);(a=this.options[a]||this.element.attr("zpp-"+a))||(a=this.emptyImageUrl.substr(0,this.emptyImageUrl.lastIndexOf("/"))+"/"+b);d.src=a},_toolbarBtnLoaded:function(a,b){b.image=a;this._log("Loaded toolbar btn '"+b+"' from "+a.src)},_getTookbarButtons:function(){var a=
[];this.toolbar&&(a=[this.toolbar.homeBtn,this.toolbar.zoomInBtn,this.toolbar.zoomOutBtn],!this._isFullscreen()&&this.toolbar.startFullscreenBtn?a.push(this.toolbar.startFullscreenBtn):this.toolbar.stopFullscreenBtn&&a.push(this.toolbar.stopFullscreenBtn));return a},_positionToolbar:function(){var a=-1!==this.toolbarPos.indexOf("top"),b=-1!==this.toolbarPos.indexOf("left"),d=-1!==this.toolbarPos.indexOf("bottom"),c=-1!==this.toolbarPos.indexOf("right"),e=parseInt(this.toolbarIconSize),f=this._supportsFullscreen()?
4:3,h=a||d;this.toolbar.w=h?f*(e+5)+5:e+10;this.toolbar.h=!h?f*(e+5)+5:e+10;this.toolbar.x=b?0:c?this.cssWidth-this.toolbar.w:Math.round((this.cssWidth-this.toolbar.w)/2);this.toolbar.y=a?0:d?this.cssHeight-this.toolbar.h:Math.round((this.cssHeight-this.toolbar.h)/2);a=["homeBtn","zoomInBtn","zoomOutBtn","startFullscreenBtn","stopFullscreenBtn"];for(b=0;b<a.length;b++)if(d=this.toolbar[a[b]])d.x=this.toolbar.x+5+(e+5)*(h?d.index:0),d.y=this.toolbar.y+5+(e+5)*(!h?d.index:0)},_bindEvents:function(){c(this.canvas).bind("DOMMouseScroll mousewheel",
c.proxy(this._onMouseWheel,this)).focus(c.proxy(this._onFocus,this)).blur(c.proxy(this._onBlur,this));c(this.canvas).hammer({prevent_default:!0}).bind("tap",c.proxy(this._onTap,this)).bind("doubletap",c.proxy(this._zoomIn,this,2)).bind("dragstart",c.proxy(this._saveOffset,this)).bind("drag",c.proxy(this._onDrag,this)).bind("pinchin",c.proxy(this._onPinch,this)).bind("pinchout",c.proxy(this._onPinch,this)).bind("keyup",c.proxy(this._onKeyup,this)).bind("release",c.proxy(this._onRelease,this));c(document).bind("webkitfullscreenchange mozfullscreenchange fullscreenchange",
c.proxy(this._onFullscreenChange,this));c(window).resize(c.proxy(this._onResize,this))},_onFocus:function(a){a.preventDefault();this.hasFocus=!0;this._repaint()},_onBlur:function(a){a.preventDefault();this.hasFocus=!1;this._repaint()},_onTap:function(a){if(this.hasFocus){var b=this._getCanvasPoint(a);this._log("Tap at %s,%s",b.x,b.y);for(var d=parseInt(this.toolbarIconSize),g=this._getTookbarButtons(),e=0;e<g.length;e++){var f=g[e];if(b.x>f.x&&b.x<f.x+d&&b.y>f.y&&b.y<f.y+d){f.action();a.preventDefault();
break}}}else c(this.canvas).focus()},_onKeyup:function(a){switch(a.keyCode||a.which){case 70:this._toggleFullscreen();break;case 27:c(this.canvas).blur();break;case 107:case 171:case 187:this._zoomIn(1.1);break;case 109:case 173:case 189:this._zoomOut(1.1)}},_onMouseWheel:function(a){a.preventDefault();"DOMMouseScroll"==a.type&&0<a.originalEvent.detail||"mousewheel"==a.type&&0>a.originalEvent.wheelDelta?this._zoomOut(1.1,a):this._zoomIn(1.1,a)},_onDrag:function(a){a.preventDefault();this._wasPinchEvent(a)||
(this.offset.x=this.offset.x0+a.gesture.deltaX*this.deviceRatio,this.offset.y=this.offset.y0+a.gesture.deltaY*this.deviceRatio,this._requestRepaint())},_wasPinchEvent:function(a){return"undefined"==typeof a.gesture.startEvent.scale0?!1:!0},_onPinch:function(a){a.preventDefault();if(a.gesture.startEvent){this._wasPinchEvent(a)||(a.gesture.startEvent.scale0=this.scale,a.gesture.startEvent.x0=this.offset.x,a.gesture.startEvent.y0=this.offset.y,a.gesture.startEvent.cx0=a.gesture.center.pageX,a.gesture.startEvent.cy0=
a.gesture.center.pageY);this.scale=a.gesture.startEvent.scale0*a.gesture.scale;this._adjustScale();var b=this._pageToCanvas(a.gesture.startEvent.cx0,a.gesture.startEvent.cy0);b.x*=this.deviceRatio;b.y*=this.deviceRatio;var d=this.scale/a.gesture.startEvent.scale0;this.offset.x=b.x-(b.x-a.gesture.startEvent.x0)*d;this.offset.y=b.y-(b.y-a.gesture.startEvent.y0)*d;this._requestRepaint()}},_onRelease:function(a){a.preventDefault();this._wasPinchEvent(a)&&(this._checkZoomLevelAsync(),this._requestRepaint())},
_onResize:function(){},_onFullscreenChange:function(){this._isFullscreen()?(this.cssWidth=screen.width,this.cssHeight=screen.height):(c(this.canvas).removeClass("zppFullScreen"),this.cssWidth=this.cssWidth0,this.cssHeight=this.cssHeight0);this.width=Math.round(this.cssWidth/this.deviceRatio);this.height=Math.round(this.cssHeight/this.deviceRatio);c(this.canvas).css("width",this.cssWidth);c(this.canvas).css("height",this.cssHeight);c(this.canvas).attr("width",this.width);c(this.canvas).attr("height",
this.height);this._reset()},_reset:function(){"undefined"!=typeof this.level&&this._releaseImages(this.zoomLevels[this.level]);delete this.level;this._loadZoomLevel();this._positionToolbar();this._repaint()},_saveOffset:function(){this.offset.x0=this.offset.x;this.offset.y0=this.offset.y},_supportsFullscreen:function(){return this.canvas.requestFullscreen||this.canvas.mozRequestFullScreen||this.canvas.webkitRequestFullscreen},_isFullscreen:function(){return document.fullscreenElement||document.mozFullScreenElement||
document.webkitFullscreenElement},_toggleFullscreen:function(){this._supportsFullscreen()?this._isFullscreen()?(document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),c(this.canvas).removeClass("zppFullScreen")):(this.cssWidth0=parseInt(c(this.canvas).css("width")),this.cssHeight0=parseInt(c(this.canvas).css("height")),c(this.canvas).addClass("zppFullScreen"),this.canvas.requestFullscreen?
this.canvas.requestFullscreen():this.canvas.mozRequestFullScreen?this.canvas.mozRequestFullScreen():this.canvas.webkitRequestFullscreen&&this.canvas.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)):alert("Fullscreen mode not supported")},_zoomIn:function(a,b){this._zoom(a?a:1.1,b)},_zoomOut:function(a,b){this._zoom(a?1/a:1/1.1,b)},_zoom:function(a,b){var d=this._getCanvasPoint(b),c=this.scale;this.scale*=a;this._adjustScale();0.001<Math.abs(this.scale-c)&&(a=this.scale/c,d.x*=this.deviceRatio,
d.y*=this.deviceRatio,this.offset.x=d.x-(d.x-this.offset.x)*a,this.offset.y=d.y-(d.y-this.offset.y)*a,this._checkZoomLevelAsync(),this._requestRepaint())},_getCanvasPoint:function(a){var b={x:this.canvas.width/2,y:this.canvas.height/2};a&&("DOMMouseScroll"==a.type||"mousewheel"==a.type?b=this._pageToCanvas(a.originalEvent.pageX,a.originalEvent.pageY):"doubletap"==a.type||"tap"==a.type?b=this._pageToCanvas(a.gesture.center.pageX,a.gesture.center.pageY):"click"==a.type&&(b=this._pageToCanvas(a.pageX,
a.pageY)));return b},_pageToCanvas:function(a,b){var d=c(this.canvas).offset();return{x:a-d.left,y:b-d.top}},_loadImageProperties:function(){this._log("Loading ZppViewer");var a=this;delete a.imageWidth;delete a.imageHeight;delete a.tileSize;c.ajax({url:this.src+"/ImageProperties.xml",context:a,success:function(b){var d=b;if("string"==typeof b||b instanceof String)d=c.parseXML(b);d=c(d).find("IMAGE_PROPERTIES");a.imageWidth=parseInt(c(d).attr("WIDTH"));a.imageHeight=parseInt(c(d).attr("HEIGHT"));
a.tileSize=parseInt(c(d).attr("TILESIZE"));!b||!a.imageWidth||!a.imageHeight||!a.tileSize?console.error("Not a properly formatted "+this.src+"/ImageProperties.xml"):(this._log("Loaded "+this.src+"/ImageProperties.xml: width=%d, height=%d, tile-size=%d",this.imageWidth,this.imageHeight,this.tileSize),this._calculateZoomLevels())},error:function(){console.error("Unable to load "+this.src+"/ImageProperties.xml")}})},_calculateZoomLevels:function(){this.zoomLevels=[];for(var a=this.imageWidth,b=this.imageHeight;;){this.zoomLevels.push({level:0,
imageWidth:a,imageHeight:b,horizTileNo:Math.ceil(a/this.tileSize),vertTileNo:Math.ceil(b/this.tileSize),tileGroup:[],images:[],loading:[]});if(Math.max(a,b)<=this.tileSize)break;a=Math.floor(a/2);b=Math.floor(b/2)}this.zoomLevels.reverse();for(var d=b=a=0;d<this.zoomLevels.length;d++){var c=this.zoomLevels[d];c.level=d;for(var e=0;e<c.horizTileNo*c.vertTileNo;e++)c.tileGroup.push(b),256<=++a&&(a=0,b++)}this._log("#Zoom levels "+this.zoomLevels.length);this._loadZoomLevel()},_checkZoomLevelAsync:function(){this.checkZoomLevelTimer&&
clearTimeout(this.checkZoomLevelTimer);var a=this;this.checkZoomLevelTimer=setTimeout(function(){a._checkZoomLevel();delete a.checkZoomLevelTimer},200)},_checkZoomLevel:function(){for(var a=this.level;1.01<this.scale&&this.level<this.zoomLevels.length-1;)this.level++,this.scale/=2,this._adjustScale();for(;0.5>this.scale&&0<this.level;)this.level--,this.scale*=2,this._adjustScale();this.level!=a&&(this._releaseImages(this.zoomLevels[a]),this._loadZoomLevel())},_loadZoomLevel:function(){"undefined"==
typeof this.level&&(this.offset.x=0,this.offset.y=0,this._computeZoomLevelAndScale());this._log("Loading zoom level "+this.level);var a=this.zoomLevels[this.level];this._releaseImages(a);for(var b=this._computeRepaintTiles(),d=b.y;d<b.y+b.h;d++)for(var c=b.x;c<b.x+b.w;c++)this._loadImage(a,c,d)},_releaseAllImages:function(){for(zoomlevel in this.zoomlevels)_releaseImages(zoomlevel)},_releaseImages:function(a){for(img in a.images)this._releaseImage(img);delete a.images;a.images=[];for(img in a.loading)this._releaseImage(img);
delete a.loading;a.loading=[]},_releaseImagesOutsideTiles:function(a,b){for(var d=0;d<a.vertTileNo;d++)for(var c=0;c<a.horizTileNo;c++)if(d<b.y||d>=b.y+b.h||c<b.x||c>=b.x+b.w){var e=d*a.horizTileNo+c;null!=a.images[e]&&(this._releaseImage(a.images[e]),a.images[e]=null);null!=a.loading[e]&&(this._releaseImage(a.loading[e]),a.loading[e]=null)}},_releaseImage:function(a){null!=a&&(a.onload=null,a.src=this.emptyImageUrl)},_loadImage:function(a,b,d){var g=d*a.horizTileNo+b;if(null==a.loading[g]){var e=
this.src+"/TileGroup"+a.tileGroup[g]+"/"+a.level+"-"+b+"-"+d+".jpg",f=new Image;f.setAttribute("tileX",b);f.setAttribute("tileY",d);f.setAttribute("level",a.level);f.onload=c.proxy(this._imageLoaded,this,f);a.loading[g]=f;f.src=e}},_loadThumbnail:function(){var a=this,b=this.src+"/TileGroup0/0-0-0.jpg";this._log("Loading thumbnail %s",b);var d=new Image;d.onload=function(){a.thumbImage=this};d.src=b},_imageLoaded:function(a){var b=parseInt(a.getAttribute("level")),d=this.zoomLevels[b],c=parseInt(a.getAttribute("tileX")),
c=parseInt(a.getAttribute("tileY"))*d.horizTileNo+c;d.loading[c]=null;this.level==b?(d.images[c]=a,this._repaint()):this._releaseImage(a)},_getImage:function(a,b,d){b=d*a.horizTileNo+b;return null!=a.images[b]?a.images[b]:null},_computeZoomLevelAndScale:function(){for(this.level=0;this.level<this.zoomLevels.length-1&&this.zoomLevels[this.level].imageWidth<this.width&&this.zoomLevels[this.level].imageHeight<this.height;)this.level++;this.scale=Math.min(1,Math.min(this.width/this.zoomLevels[this.level].imageWidth,
this.height/this.zoomLevels[this.level].imageHeight));this._adjustScale()},_countCachedImageNo:function(){for(var a=0,b=this.zoomLevels[this.level].images,d=0;d<b.length;d++)null!=b[d]&&a++;return a},_countLoadingImageNo:function(){for(var a=0,b=this.zoomLevels[this.level].loading,d=0;d<b.length;d++)null!=b[d]&&a++;return a},_round:function(a){return Math.round(a/this.deviceRatio)},_floor:function(a){return Math.floor(a/this.deviceRatio)},_ceil:function(a){return Math.ceil(a/this.deviceRatio)},_repaint:function(){(new Date).getTime();
this.repaintTimer&&clearTimeout(this.repaintTimer);var a=this;this.repaintTimer=setTimeout(function(){a._repaintZoomLevel();delete a.repaintTimer},100)},_requestRepaint:function(){reqAnimFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame;reqAnimFrame(c.proxy(this._repaintZoomLevel,this))},_repaintZoomLevel:function(){this.lastRepaintTime=(new Date).getTime();this.background?(this.context.fillStyle=this.background,
this.context.fillRect(0,0,this.width,this.height)):this.context.clearRect(0,0,this.width,this.height);this._adjustImageOffset();var a=this._computeRepaintTiles(),b=this.zoomLevels[this.level];this.thumbImage&&(this.context.save(),this.context.rect(0,0,this.width,this.height),this.context.clip(),this.context.drawImage(this.thumbImage,0,0,this.thumbImage.width,this.thumbImage.height,this._floor(this.offset.x),this._floor(this.offset.y),this._ceil(b.imageWidth*this.scale),this._ceil(b.imageHeight*this.scale)),
this.context.restore());for(var d=a.y;d<a.y+a.h;d++)for(var c=a.x;c<a.x+a.w;c++){var e=this._getImage(b,c,d);if(e){var f=d*this.tileSize;this.context.drawImage(e,this._floor(this.offset.x+c*this.tileSize*this.scale),this._floor(this.offset.y+f*this.scale),this._ceil(e.width*this.scale),this._ceil(e.height*this.scale))}else this._loadImage(b,c,d);this.trace&&(this.context.beginPath(),this.context.lineWidth="2",this.context.strokeStyle="black",this.context.rect(this._floor(this.offset.x+c*this.tileSize*
this.scale),this._floor(this.offset.y+d*this.tileSize*this.scale),this._ceil(this.tileSize*this.scale),this._ceil(this.tileSize*this.scale)),this.context.stroke())}this.toolbar&&this.hasFocus&&this._repaintToolbar();this._releaseImagesOutsideTiles(b,a);this.trace&&(a="size "+this.width+", "+this.height+", scale="+this.scale.toFixed(2)+", level="+this.level+", tiles=("+a.x+","+a.y+","+a.w+","+a.h+"), cached images="+this._countCachedImageNo(),b=this.context.measureText(a),this.context.fillStyle="rgba(200,200,200,0.5)",
this.context.fillRect(0,0,parseInt(b.width)+15,15),this.context.fillStyle="black",this.context.fillText(a,10,10))},_repaintToolbar:function(){this.context.save();this.context.globalAlpha=0.3;this.context.fillStyle="#777777";this.context.fillRect(this.toolbar.x,this.toolbar.y,this.toolbar.w,this.toolbar.h);for(var a=parseInt(this.toolbarIconSize),b=this._getTookbarButtons(),d=0;d<b.length;d++){var c=b[d];c.image&&this.context.drawImage(c.image,0,0,c.image.width,c.image.height,c.x,c.y,a,a)}this.context.restore()},
_computeRepaintTiles:function(){var a=this.zoomLevels[this.level],b=Math.max(0,-this.offset.x/this.scale),c=Math.max(0,-this.offset.y/this.scale),g=Math.min(this.width/this.scale,a.imageWidth),e=Math.min(this.height/this.scale,a.imageHeight),a=Math.floor(b/this.tileSize),f=Math.floor(c/this.tileSize),b=Math.ceil((b+g)/this.tileSize)-a,c=Math.ceil((c+e)/this.tileSize)-f;return{x:a,y:f,w:b,h:c}},_adjustImageOffset:function(){var a=this.zoomLevels[this.level].imageWidth*this.scale,b=this.zoomLevels[this.level].imageHeight*
this.scale,c=this.width-a,g=this.height-b;0<c?this.offset.x=c/2:0<this.offset.x?this.offset.x=0:this.offset.x+a<this.width&&(this.offset.x=this.width-a);0<g?this.offset.y=g/2:0<this.offset.y?this.offset.y=0:this.offset.y+b<this.height&&(this.offset.y=this.height-b)},_adjustScale:function(){var a=this.zoomLevels[this.level].imageWidth*this.scale;return a<this.zoomLevels[0].imageWidth?(this.scale=this.zoomLevels[0].imageWidth/this.zoomLevels[this.level].imageWidth,!0):a>this.zoomLevels[this.zoomLevels.length-
1].imageWidth?(this.scale=this.zoomLevels[this.zoomLevels.length-1].imageWidth/this.zoomLevels[this.level].imageWidth,!0):!1},_log:function(){if(this.debug&&"undefined"!==typeof console&&void 0!==console.log)try{console.log.apply(console,arguments)}catch(a){Function.prototype.bind.call(console.log,console).apply(console,arguments)}},destroy:function(){c.Widget.prototype.destroy.apply(this,arguments);this._releaseAllImages();this.thumbImage&&(this._releaseImage(this.thumbImage),delete this.thumbImage)},
version:function(){return"1.1.0"}})})(jQuery);
